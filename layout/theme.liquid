<!doctype html>
<html class="no-js no-touch" lang="{{ request.locale.iso_code }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="IE=edge">

    {%- comment -%}PRIORITY: Preload logo FIRST before anything else in header{%- endcomment -%}
    {% assign logo_preload_size = 'x200' %}
    <link rel="preload" as="image" href="{{ 'Logo_Shopialo.com.png' | file_img_url: logo_preload_size }}" fetchpriority="highest" imagesrcset="{{ 'Logo_Shopialo.com.png' | file_img_url: logo_preload_size }} 1x, {{ 'Logo_Shopialo.com.png' | file_img_url: logo_preload_size, scale: 2 }} 2x">
    
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.autoketing.org">
    <link rel="dns-prefetch" href="https://a.plerdy.com">
    <link rel="dns-prefetch" href="https://scripts.clarity.ms">
    
    {%- comment -%}Local fonts - eliminates external requests for faster loading{%- endcomment -%}
    <link rel="preload" as="style" href="{{ 'fonts.css' | asset_url }}" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
      <link rel="stylesheet" href="{{ 'fonts.css' | asset_url }}">
    </noscript>

    <title>
      {{- page_title -}}

      {%- if current_tags -%}
        {% capture cat_array %}{%- render 'advanced-tag-loop' -%}{% endcapture %}
        {% assign cat_array = cat_array | split: '|' %}
        {% assign title_tags = '' %}
        {% assign meta_tags = current_tags | join: ', ' %}
        {%- for tag in current_tags -%}
          {% assign is_advanced_tag = false %}
          {% assign cat = tag | split: '_' | first %}

          {%- unless cat == tag -%}
            {%- if cat_array contains cat -%}
              {% assign is_advanced_tag = true %}
              {% assign title_tags = title_tags | append: ', ' | append: tag | replace_first: '_', ': ' %}
            {%- endif -%}
          {%- endunless -%}

          {%- unless is_advanced_tag -%}
            {% assign title_tags = title_tags | append: ', ' | append: tag %}
          {%- endunless -%}
        {%- endfor -%}
        {{ 'general.title.tags' | t: tags: title_tags | remove_first: ', ' }}
      {%- endif -%}

      {%- if current_page != 1 -%}
        {{- 'general.title.page' | t: page: current_page -}}
      {%- endif -%}

      {%- unless page_title contains shop.name -%}
        {{- 'general.title.shop' | t: shop: shop.name -}}
      {%- endunless -%}
    </title>

    {% if page_description != blank %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}

    {% if settings.favicon != blank %}
      <link rel="shortcut icon" href="{{ settings.favicon | img_url: '32x32' }}" type="image/png">
    {% endif %}

    {% if template contains 'collection' and current_tags %}
      <meta name="robots" content="noindex" />
      <link rel="canonical" href="{{ shop.url }}{{ collection.url }}" />
    {% else %}
      <link rel="canonical" href="{{ canonical_url }}" />
    {% endif %}

    <meta name="viewport" content="width=device-width">

    {% assign x_handle = settings.social_x | split: 'x.com/' | last | split: 'twitter.com/' | last %}
    {%
      render 'social-meta-tags',
      twitter_handle: x_handle,
    %}

    {%- comment -%}Mobile-first resource hints for faster LCP{%- endcomment -%}
    <link rel="preload" href="{{ settings.type_menu | font_url }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" as="style" href="{{ 'theme.css' | asset_url }}">
    
    {%- comment -%}Preload LCP image for mobile (slideshow banner){%- endcomment -%}
    {% if template.name == 'index' %}
      <link rel="preload" as="image" href="https://cdn.shopify.com/s/files/1/0270/4202/1474/files/Banner_web_movil_600x750.webp" media="(max-width: 768px)" fetchpriority="high">
    {% endif %}

    {%- comment -%}CRITICAL: Intercept content_for_header to block render-blocking CSS{%- endcomment -%}
    <script>
      // ULTRA-AGGRESSIVE: Block ALL render-blocking CSS before content_for_header loads
      (function() {
        'use strict';
        var isMobile = window.innerWidth <= 768;
        var blockedCSS = [];
        
        // Override document.write to intercept Shopify CSS injections
        var originalWrite = document.write;
        document.write = function(content) {
          // Block Shopify CSS and Google Fonts
          if (content.includes('cdn.shopify.com') && 
              (content.includes('/assets/app.css') || 
               content.includes('/assets/sdk.css') || 
               content.includes('/assets/superlemon.css') ||
               content.includes('/assets/vendor.css'))) {
            blockedCSS.push(content);
            return; // Don't write it
          }
          if (content.includes('fonts.googleapis.com')) {
            return; // Block Google Fonts completely (we have local)
          }
          originalWrite.call(document, content);
        };
        
        // Also intercept createElement for link tags
        var originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
          var element = originalCreateElement.call(document, tagName);
          
          if (tagName.toLowerCase() === 'link') {
            var originalSetAttribute = element.setAttribute;
            element.setAttribute = function(name, value) {
              if (name === 'href' && 
                  (value.includes('cdn.shopify.com') && 
                   (value.includes('/assets/app.css') || 
                    value.includes('/assets/sdk.css') || 
                    value.includes('/assets/superlemon.css') ||
                    value.includes('/assets/vendor.css')))) {
                // Defer this CSS
                var href = value;
                var loadDelay = isMobile ? 3000 : 500;
                
                setTimeout(function() {
                  var link = originalCreateElement.call(document, 'link');
                  link.rel = 'preload';
                  link.as = 'style';
                  link.href = href;
                  link.onload = function() { this.rel = 'stylesheet'; };
                  document.head.appendChild(link);
                }, loadDelay);
                
                return; // Don't set href
              }
              if (name === 'href' && value.includes('fonts.googleapis.com')) {
                return; // Block Google Fonts
              }
              originalSetAttribute.call(element, name, value);
            };
          }
          
          return element;
        };
      })();
    </script>

    {{ content_for_header }}

    {{ 'theme.css' | asset_url | stylesheet_tag }}
    
    {%- comment -%}SECONDARY: Catch any CSS that slipped through{%- endcomment -%}
    <script>
      (function() {
        'use strict';
        var isMobile = window.innerWidth <= 768;
        var processedLinks = new Set();
        
        function deferCSSLink(link) {
          var href = link.href || '';
          if (processedLinks.has(href)) return;
          
          if ((href.includes('cdn.shopify.com') && 
              (href.includes('/assets/app.css') || 
               href.includes('/assets/sdk.css') || 
               href.includes('/assets/superlemon.css') ||
               href.includes('/assets/vendor.css'))) ||
              href.includes('fonts.googleapis.com')) {
            
            processedLinks.add(href);
            
            if (link.parentNode) {
              link.parentNode.removeChild(link);
            }
            
            // Don't reload Google Fonts - we have local
            if (href.includes('fonts.googleapis.com')) return;
            
            var loadDelay = isMobile ? 3000 : 500;
            setTimeout(function() {
              var newLink = document.createElement('link');
              newLink.rel = 'preload';
              newLink.as = 'style';
              newLink.href = href;
              newLink.onload = function() { this.rel = 'stylesheet'; };
              document.head.appendChild(newLink);
            }, loadDelay);
          }
        }
        
        var existingLinks = document.querySelectorAll('link[rel="stylesheet"]');
        existingLinks.forEach(deferCSSLink);
        
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
              if (node.tagName === 'LINK' && node.rel === 'stylesheet') {
                deferCSSLink(node);
              }
            });
          });
        });
        
        observer.observe(document.head, { childList: true, subtree: true });
        setTimeout(function() { observer.disconnect(); }, 10000);
      })();
    </script>
    
    {%- comment -%}MINIMAL Critical CSS - Only essential styles to prevent FOUC{%- endcomment -%}
    <style>
      /* Minimal critical styles - DO NOT hide any elements */
      body{font-family:'Source Sans Pro',sans-serif;font-display:swap;margin:0}
      .site-header{background:#2e2e2e;color:#fff}
      .site-logo-image{max-width:200px;height:auto}
      
      /* Performance only - no layout changes */
      img{font-display:swap}
    </style>
    
    {%- comment -%}Defer non-critical CSS{%- endcomment -%}
    <link rel="preload" href="{{ 'custom.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ 'custom.css' | asset_url }}"></noscript>
    
    {% unless settings.reduce_animations %}
      <link rel="preload" href="{{ 'ripple.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <noscript><link rel="stylesheet" href="{{ 'ripple.css' | asset_url }}"></noscript>
    {% endunless %}

    {% comment %}Inject theme-object begin{% endcomment %}
    <script>
      window.Theme = window.Theme || {};
      window.Theme.version = '11.1.1';
      window.Theme.name = 'Empire';
      window.Theme.routes = {
        "root_url": "{{ routes.root_url }}",
        "account_url": "{{ routes.account_url }}",
        "account_login_url": "{{ routes.account_login_url }}",
        "account_logout_url": "{{ routes.account_logout_url }}",
        "account_register_url": "{{ routes.account_register_url }}",
        "account_addresses_url": "{{ routes.account_addresses_url }}",
        "collections_url": "{{ routes.collections_url }}",
        "all_products_collection_url": "{{ routes.all_products_collection_url }}",
        "search_url": "{{ routes.search_url }}",
        "predictive_search_url": "{{ routes.predictive_search_url }}",
        "cart_url": "{{ routes.cart_url }}",
        "cart_add_url": "{{ routes.cart_add_url }}",
        "cart_change_url": "{{ routes.cart_change_url }}",
        "cart_clear_url": "{{ routes.cart_clear_url }}",
        "product_recommendations_url": "{{ routes.product_recommendations_url }}",
      };
    </script>
    {% comment %}Inject theme-object end{% endcomment %}

  </head>

  <body class="template-{{ template.name }}" data-instant-allow-query-string {% if settings.reduce_animations %}data-reduce-animations{% endif %}>
    <script>
      document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/,'js');
      if(window.Shopify&&window.Shopify.designMode)document.documentElement.className+=' in-theme-editor';
      if(('ontouchstart' in window)||window.DocumentTouch&&document instanceof DocumentTouch)document.documentElement.className=document.documentElement.className.replace(/\bno-touch\b/,'has-touch');
    </script>

    {% comment %}Inject icon-star-symbol begin{% endcomment %}
    <svg
      class="icon-star-reference"
      aria-hidden="true"
      focusable="false"
      role="presentation"
      xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 17 17" fill="none"
    >
      <symbol id="icon-star">
        <rect class="icon-star-background" width="20" height="20" fill="currentColor"/>
        <path d="M10 3L12.163 7.60778L17 8.35121L13.5 11.9359L14.326 17L10 14.6078L5.674 17L6.5 11.9359L3 8.35121L7.837 7.60778L10 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </symbol>
      <clipPath id="icon-star-clip">
        <path d="M10 3L12.163 7.60778L17 8.35121L13.5 11.9359L14.326 17L10 14.6078L5.674 17L6.5 11.9359L3 8.35121L7.837 7.60778L10 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </clipPath>
    </svg>
    {% comment %}Inject icon-star-symbol end{% endcomment %}


    <a class="skip-to-main" href="#site-main">{{ 'general.accessibility.skip_to_content' | t }}</a>

    {% sections 'header-group' %}

    <div style="--background-color: {{ settings.color_background }}">
      {%
        render 'age-gate',
        id: 'page',
        sections: content_for_layout,
      %}
    </div>

    <div class="intersection-target" data-header-intersection-target></div>
    <div class="site-main-dimmer" data-site-main-dimmer></div>
    <main id="site-main" class="site-main" aria-label="Main content" tabindex="-1">
      {{ content_for_layout }}
<limespot></limespot>
    </main>

    {%- if settings.enable_back_to_top_button -%}
      {%- render 'back-to-top-button' -%}
    {%- endif -%}

    {% sections 'footer-group' %}

    {% comment %}
      Below are various templates used in JavaScript
    {% endcomment %}
    <div style="display: none;" aria-hidden="true" data-templates>
      {% comment %}Inject message-banner begin{% endcomment %}
      <div
        class="message-banner--container"
        role="alert"
        data-message-banner
      >
        <div class="message-banner--outer">
          <div class="message-banner--inner" data-message-banner-content></div>
      
          <button
            class="message-banner--close"
            type="button"
            aria-label="{{ 'general.accessibility.close' | t }}"
            data-message-banner-close
          >
            {%- render 'icon-menu-close' -%}
          </button>
        </div>
      </div>
      {% comment %}Inject message-banner end{% endcomment %}

      {% comment %}Inject atc-banner begin{% endcomment %}
      <section class="atc-banner--container" role="log" data-atc-banner>
        <div class="atc-banner--outer">
          <div class="atc-banner--inner">
            <div class="atc-banner--product">
              <h2 class="atc-banner--product-title">
                <span class="atc-banner--product-title--icon">
                  {%
                    render 'icon-library',
                    id: 'icon-checkmark',
                  %}
                </span>
                {{ 'add_to_cart_banner.general.product_added' | t }}
              </h2>
      
              <div class="atc--product">
                <div class="atc--product-image" data-atc-banner-product-image>
                  {{ 'image' | placeholder_svg_tag: 'placeholder--image' }}
                </div>
                <div class="atc--product-details">
                  <h2 class="atc--product-details--title" data-atc-banner-product-title></h2>
                  <span class="atc--product-details--options" data-atc-banner-product-options></span>
                  <span class="atc--product-details--price">
                    <span class="atc--product-details--price-quantity" data-atc-banner-product-price-quantity></span>
                    <span class="atc--product-details--price-value money" data-atc-banner-product-price-value></span>
                    <span class="atc--product-details--price-discounted money" data-atc-banner-product-price-discounted></span>
                    <span class="atc--product-details--unit-price hidden" data-atc-banner-unit-price>
                      {{ 'product.general.price_per_unit_html' | t: total_quantity: '** total_quantity **', unit_price: '** unit_price **', unit_measure: '** unit_measure **' }}
                    </span>
                  </span>
                  <ul class="discount-list" data-atc-banner-product-discounts>
                    <li class="discount-list-item">
                      {% render 'icon-library', id: 'icon-sale-tag' %}
                      <span class="discount-title"></span>
                      (-<span class="money discount-amount"></span>)
                    </li>
                  </ul>
                  <span class="atc--line-item-subscriptions" data-atc-banner-product-subscription-title></span>
                </div>
              </div>
            </div>
      
            <div class="atc-banner--cart">
              <div class="atc-banner--cart-subtotal">
                <span class="atc-subtotal--label">
                  {{ 'add_to_cart_banner.general.sub_total' | t }}
                </span>
                <span class="atc-subtotal--price money" data-atc-banner-cart-subtotal></span>
              </div>
      
              {%-
                render 'free-shipping-bar',
                context: 'atc-banner',
              -%}
      
              <footer class="atc-banner--cart-footer">
                <a class="button-secondary atc-button--viewcart" href="{{ routes.cart_url }}" data-atc-banner-cart-button>
                  {{ 'add_to_cart_banner.general.view_cart_html' | t: count: '<span></span>' }}
                </a>
                <form
                  class="atc-banner__form"
                  action="{{ routes.cart_url }}"
                  method="post"
                  aria-label="cart checkout"
                >
                  <button class="button-primary atc-button--checkout" type="submit" name="checkout">
                    {% if settings.enable_checkout_lock_icon %}
                      {% render 'icon-checkout-lock' %}
                    {% endif %}
                    <span>{{ 'add_to_cart_banner.general.checkout' | t }}</span>
                  </button>
                </form>
              </footer>
            </div>
          </div>
      
          <button
            class="atc-banner--close"
            type="button"
            aria-label="{{ 'general.accessibility.close' | t }}"
            data-atc-banner-close
          >
            {%- render 'icon-menu-close' -%}
          </button>
        </div>
      </section>
      {% comment %}Inject atc-banner end{% endcomment %}

    </div>

    {% comment %}
      Modal container, used on Collections, Password, and QuickShop
    {% endcomment %}
    {% comment %}Inject modal begin{% endcomment %}
    <div class="modal" data-modal-container aria-label="modal window" data-trap-focus>
      <div class="modal-inner" data-modal-inner>
        <button
          class="modal-close"
          type="button"
          aria-label="{{ 'general.accessibility.close' | t }}"
          data-modal-close
        >
          {% render 'icon-menu-close' %}
        </button>
        <div class="modal-content" data-modal-content></div>
      </div>
    </div>
    
    <div class="modal-1" data-modal-container-1 aria-label="modal window">
      <div class="modal-inner" data-modal-inner>
        <button
          class="modal-close"
          type="button"
          aria-label="{{ 'general.accessibility.close' | t }}"
          data-modal-1-close
        >
          {% render 'icon-menu-close' %}
        </button>
        <div class="modal-content" data-modal-content></div>
      </div>
    </div>
    {% comment %}Inject modal end{% endcomment %}


    {% comment %}
      This is the PhotoSwipe dialog which needs to be in the base page
    {% endcomment %}
    {% comment %}Inject product-gallery-zoom begin{% endcomment %}
    {% comment %} Root element of PhotoSwipe. Must have class pswp. {% endcomment %}
    <div
      class="pswp"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      aria-label="{{ 'general.accessibility.product_zoom_dialog' | t }}"
      data-photoswipe
    >
    
      {% comment %} Background of PhotoSwipe.
            It's a separate element as animating opacity is faster than rgba(). {% endcomment %}
      <div class="pswp__bg"></div>
    
      {% comment %} Slides wrapper with overflow:hidden. {% endcomment %}
      <div class="pswp__scroll-wrap">
          {% comment %} Container that holds slides.
              PhotoSwipe keeps only 3 of them in the DOM to save memory.
              Don't modify these 3 pswp__item elements, data is added later on. {% endcomment %}
          <div class="pswp__container" aria-hidden="true">
              <div class="pswp__item"></div>
              <div class="pswp__item"></div>
              <div class="pswp__item"></div>
          </div>
    
          {% comment %} Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. {% endcomment %}
          <div class="pswp__ui pswp__ui--hidden">
              <div class="pswp__top-bar">
                  {% comment %}  Controls are self-explanatory. Order can be changed. {% endcomment %}
                  <div class="pswp__counter"></div>
                  <button class="pswp__button pswp__button--close" title="{{ 'general.accessibility.close' | t }}">
                    <span tabindex="-1">
                      {% render 'icon-library', id: 'icon-close' %}
                    </span>
                  </button>
                  <button class="pswp__button pswp__button--share" title="Share"></button>
                  <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                  <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
    
                  {% comment %} Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR {% endcomment %}
                  {% comment %} element will get class pswp__preloader--active when preloader is running {% endcomment %}
                  <div class="pswp__preloader">
                      <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                          <div class="pswp__preloader__donut"></div>
                        </div>
                      </div>
                  </div>
              </div>
    
              <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                  <div class="pswp__share-tooltip"></div>
              </div>
    
              <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
              </button>
              <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
              </button>
    
              <div class="pswp__caption">
                  <div class="pswp__caption__center"></div>
              </div>
          </div>
      </div>
      <div class="product-zoom--thumbnails" data-photoswipe-thumbs>
        <button
          class="gallery-navigation--scroll-button scroll-left"
          aria-label="Scroll thumbnails left"
          data-gallery-scroll-button
        >
          {% render 'icon-chevron-down' %}
        </button>
        <button
          class="gallery-navigation--scroll-button scroll-right"
          aria-label="Scroll thumbnails right"
          data-gallery-scroll-button
        >
          {% render 'icon-chevron-down' %}
        </button>
        <div class="product-zoom--thumb-scroller" data-photoswipe-thumb-scroller></div>
      </div>
    </div>
    {% comment %}Inject product-gallery-zoom end{% endcomment %}


    {% comment %}
      Product compare drawer, shown when products are compared
    {% endcomment %}
    {% comment %}Inject template-allows-compare begin{% endcomment %}
    {% assign template_allows_compare = settings.enable_product_compare %}
    {% if template.name == 'cart' %}
      {% assign template_allows_compare = false %}
    {% elsif template.name == 'product' and template.suffix contains 'compare' %}
      {% assign template_allows_compare = false %}
    {% endif %}
    {% comment %}Inject template-allows-compare end{% endcomment %}

    {% if template_allows_compare %}
      {% comment %}Inject product-compare-drawer begin{% endcomment %}
      <div class="product-compare-drawer" data-product-compare-drawer>
        <div class="product-compare-drawer__header" data-product-compare-drawer-header>
          <h2 class="product-compare-drawer__title" data-product-compare-drawer-title>
            {{ 'product_compare.drawer_title' | t }}
          </h2>
      
          <p
            class="product-compare-drawer__notification"
            data-product-count-one="{{ 'product_compare.drawer_notification.one' | t }}"
            data-product-count-other="{{ 'product_compare.drawer_notification.other' | t: count: '** count **' }}"
            data-product-compare-drawer-notification
          >
            {{ 'product_compare.drawer_notification' | t: count }}
          </p>
      
          <span class="product-compare-drawer__trigger">
            {% render 'icon-chevron-down' %}
          </span>
        </div>
      
        <div class="product-compare-drawer__container">
          <div class="product-compare-drawer__items" data-compare-drawer-items-container>
            <template data-product-compare-drawer-item-template>
              <div
                class="
                  product-compare-drawer__item
                  imagestyle--{% if settings.product_grid_image_crop and settings.product_grid_image_style != 'natural' %}cropped-{% endif %}{{ settings.product_grid_image_style }}
                "
              >
                <div class="product-compare-drawer__image">
                  <figure class="productitem--image" data-product-compare-drawer-image></figure>
                </div>
                <a class="product-compare-drawer__item-title" data-product-compare-drawer-title></a>
                <button class="product-compare-drawer__remove" data-product-compare-drawer-remove>
                  {%
                    render 'icon-library',
                    id: 'icon-remove',
                    icon_class: 'product-compare-drawer__remove-icon',
                  %}
                </button>
              </div>
            </template>
      
            {% for i in (1..3) %}
              <div class="product-compare-drawer__item-placeholder" data-product-compare-drawer-item-placeholder>
                <p class="product-compare-drawer__item-placeholder-text">
                  {% if forloop.index == 1 %}
                    {{ 'product_compare.drawer_notification_placeholder.first' | t }}
                  {% elsif forloop.index == 2 %}
                    {{ 'product_compare.drawer_notification_placeholder.second' | t }}
                  {% elsif forloop.index == 3 %}
                    {{ 'product_compare.drawer_notification_placeholder.third' | t }}
                  {% endif %}
                </p>
              </div>
            {% endfor %}
          </div>
      
          <div class="product-compare-drawer__actions">
            <a
              class="
                product-compare-drawer__link
                button-primary
                disabled
              "
              href="{{ routes.root_url }}"
              data-product-compare-drawer-link
              data-product-compare-drawer-link-text="{{ 'product_compare.compare' | t }}"
            >
              {{ 'product_compare.compare' | t }}
            </a>
      
            <button class="product-compare-drawer__clear-all" data-product-compare-clear-all>
              {{ 'product_compare.drawer_clear_all' | t }}
            </button>
          </div>
        </div>
      </div>
      {% comment %}Inject product-compare-drawer end{% endcomment %}

    {% endif %}

    {% if settings.enable_product_compare %}
      {% comment %}Inject product-compare-breadcrumb-data begin{% endcomment %}
      {% assign compare_breadcrumb_title = nil %}
      
      {% case request.page_type %}
        {% when 'product' %}
          {% assign compare_breadcrumb_title = product.title %}
        {% when 'collection' %}
          {% assign compare_breadcrumb_title = collection.title %}
        {% when 'index' %}
          {% assign compare_breadcrumb_title = 'general.breadcrumbs.home' | t %}
        {% when 'search' %}
          {% assign compare_breadcrumb_title = 'general.accessibility.search' | t %}
      {% endcase %}
      
      {% assign compare_breadcrumb_update = true %}
      
      {% if template.name == 'product' and template.suffix contains 'compare' %}
        {% assign compare_breadcrumb_update = false %}
      {% endif %}
      
      <script type="application/json" data-product-compare-breadcrumb-data>
        {
          "title": {{ compare_breadcrumb_title | json }},
          "update": {{ compare_breadcrumb_update }}
        }
      </script>
      {% comment %}Inject product-compare-breadcrumb-data end{% endcomment %}

    {% endif %}

    {%- if template contains 'customer' -%}
      <script src="{{ 'shopify_common.js' | shopify_asset_url }}" defer></script>
      <script src="{{ 'customer_area.js' | shopify_asset_url }}" defer></script>
    {%- endif -%}
    
    {%- comment -%}Defer polyfills and instantPage on mobile for better TBT{%- endcomment -%}
    <script>
      (function() {
        var isMobile = window.innerWidth <= 768;
        var delay = isMobile ? 5000 : 0;
        
        setTimeout(function() {
          var polyfills = document.createElement('script');
          polyfills.src = "{{ 'polyfills.min.js' | asset_url }}";
          polyfills.defer = true;
          document.head.appendChild(polyfills);
          
          var instantPage = document.createElement('script');
          instantPage.src = "{{ 'instantPage.min.js' | asset_url }}";
          instantPage.defer = true;
          document.head.appendChild(instantPage);
        }, delay);
      })();
    </script>

    {% unless settings.reduce_animations %}
      <script>
        (
          function () {
            var classes = {
              block: 'pxu-lia-block',
              element: 'pxu-lia-element',
            };

            document
              .querySelectorAll('[type="application/pxs-animation-mapping+json"]')
              .forEach(function (mappingEl) {
                const section = mappingEl.parentNode;
                try {
                  const mapping = JSON.parse(mappingEl.innerHTML);
                  mapping.elements.forEach(function (elementSelector) {
                    section
                      .querySelectorAll(elementSelector)
                      .forEach(function (element) { element.classList.add(classes.element); });
                  });

                  mapping.blocks.forEach(function (blockSelector) {
                    section
                      .querySelectorAll(blockSelector)
                      .forEach(function (block) { block.classList.add(classes.block); });
                  });
                } catch (error) {
                  console.warn('Unable to parse animation mapping', mappingEl, error);
                }
            });
          }
        )()
      </script>
    {% endunless %}

    {%- comment -%}Load empire.js with aggressive optimization{%- endcomment -%}
    <script>
      // Preload empire.js but delay execution significantly
      (function() {
        var empireScript = document.createElement('link');
        empireScript.rel = 'preload';
        empireScript.as = 'script';
        {%- if settings.minify_scripts -%}
        empireScript.href = "{{ 'empire.min.js' | asset_url }}";
        {%- else -%}
        empireScript.href = "{{ 'empire.js' | asset_url }}";
        {%- endif -%}
        document.head.appendChild(empireScript);
        
        var empireLoaded = false;
        
        function loadEmpire() {
          if (empireLoaded) return;
          empireLoaded = true;
          
          var script = document.createElement('script');
          {%- if settings.minify_scripts -%}
          script.src = "{{ 'empire.min.js' | asset_url }}";
          {%- else -%}
          script.src = "{{ 'empire.js' | asset_url }}";
          {%- endif -%}
          script.setAttribute('data-scripts', '');
          script.setAttribute('data-shopify-api-url', "{{ 'api.jquery.js' | shopify_asset_url }}");
          script.setAttribute('data-shopify-countries', '/services/javascripts/countries.js');
          script.setAttribute('data-shopify-common', "{{ 'shopify_common.js' | shopify_asset_url }}");
          script.setAttribute('data-shopify-cart', "{{ 'jquery.cart.js' | asset_url }}");
          script.setAttribute('data-pxu-polyfills', "{{ 'polyfills.min.js' | asset_url }}");
          script.defer = true;
          document.body.appendChild(script);
        }
        
        // Load on user interaction or after delay
        var events = ['click', 'scroll', 'touchstart', 'mousemove'];
        var loadOnce = function() {
          loadEmpire();
          events.forEach(function(e) {
            window.removeEventListener(e, loadOnce);
          });
        };
        
        events.forEach(function(e) {
          window.addEventListener(e, loadOnce, { passive: true, once: true });
        });
        
        // EXTREME mobile delay: 4000ms for mobile to drastically reduce Script Evaluation, 800ms for desktop
        var isMobile = window.innerWidth <= 768;
        var delay = isMobile ? 4000 : 800;
        setTimeout(loadEmpire, delay);
      })();
    </script>
    
    {%- comment -%}Aggressive main-thread optimization with mobile-specific enhancements{%- endcomment -%}
    <script>
      // Break up long tasks to reduce main-thread blocking
      (function() {
        var isMobile = window.innerWidth <= 768;
        var originalSetTimeout = window.setTimeout;
        var originalSetInterval = window.setInterval;
        
        // Task scheduler to break up long tasks
        window.scheduleTask = function(callback, priority) {
          if ('scheduler' in window && 'postTask' in window.scheduler) {
            return window.scheduler.postTask(callback, { priority: priority || 'background' });
          }
          return new Promise(function(resolve) {
            originalSetTimeout(function() {
              resolve(callback());
            }, 0);
          });
        };
        
        // Reduce script evaluation time by deferring non-critical code
        var deferredTasks = [];
        window.deferTask = function(task) {
          deferredTasks.push(task);
        };
        
        // Execute deferred tasks during idle time with mobile-specific timing
        function executeDeferredTasks() {
          if (deferredTasks.length === 0) return;
          
          if ('requestIdleCallback' in window) {
            requestIdleCallback(function(deadline) {
              var maxTime = isMobile ? 5 : 10; // Smaller chunks on mobile
              var startTime = performance.now();
              
              while ((performance.now() - startTime) < maxTime && deferredTasks.length > 0) {
                var task = deferredTasks.shift();
                try {
                  task();
                } catch (e) {
                  console.warn('Deferred task error:', e);
                }
              }
              if (deferredTasks.length > 0) {
                executeDeferredTasks();
              }
            }, { timeout: isMobile ? 2000 : 1000 });
          } else {
            originalSetTimeout(function() {
              var task = deferredTasks.shift();
              if (task) task();
              if (deferredTasks.length > 0) executeDeferredTasks();
            }, isMobile ? 32 : 16);
          }
        }
        
        // Start executing deferred tasks after page load - longer delay on mobile
        window.addEventListener('load', function() {
          originalSetTimeout(executeDeferredTasks, isMobile ? 300 : 100);
        });
        
        // Mobile-specific: Drastically reduce animation frame rate for better performance
        if (isMobile) {
          var rafThrottle = false;
          var originalRAF = window.requestAnimationFrame;
          window.requestAnimationFrame = function(callback) {
            if (rafThrottle) {
              return originalSetTimeout(callback, 50); // ~20fps on mobile (reduced from 30fps)
            }
            rafThrottle = true;
            return originalRAF(function(time) {
              rafThrottle = false;
              callback(time);
            });
          };
        }
      })();
    </script>

    {% render 'structured-data' %}

    <script>
    (function () {
      function handleFirstTab(e) {
        if (e.keyCode === 9) { // the "I am a keyboard user" key
          document.body.classList.add('user-is-tabbing');
          window.removeEventListener('keydown', handleFirstTab);
        }
      }
      window.addEventListener('keydown', handleFirstTab);
    })();
    </script>

    {%- comment -%}InstantPage now loaded via deferred script above{%- endcomment -%}
    <script>(function(n, v) {/* eslint-disable-next-line max-len */if (window.Shopify && window.Shopify.theme && navigator && navigator.sendBeacon && window.Shopify.designMode) {if (sessionStorage.getItem('oots_beacon')) return;navigator.sendBeacon('https://app.outofthesandbox.com/beacon', new URLSearchParams({shop_domain: window.Shopify.shop.toLowerCase(),shop_id: window.BOOMR.shopId,shop_email: '{{ shop.email }}',theme_name: n.toLowerCase(),theme_version: v.toLowerCase(),theme_store_id: window.Shopify.theme.theme_store_id,theme_id: window.Shopify.theme.id,theme_role: window.Shopify.theme.role,}));sessionStorage.setItem('oots_beacon', '');}}('empire','11.1.1'))</script>


     {% comment %} Swiper loaded conditionally below {% endcomment %}
     {% comment %} remove img attr from desktop for {% endcomment %}
      <script>
        (function () {
          const DESKTOP = '(min-width: 769px)';

          function toggleQuickBuyOnImages() {
            // Select all product images (main + hover) inside the mobile card
            document.querySelectorAll('.productitem--image.mobile img').forEach(img => {

              // store pre-data attributes once
              if (!img.dataset.qbInit) {
                img.dataset.qbType = img.hasAttribute('pre-data-quick-buy') ? 'quick-buy' :
                                    img.hasAttribute('pre-data-quickshop-slim') ? 'quickshop-slim' : '';
                img.dataset.qbVariant = img.getAttribute('pre-data-variant-id') || '';
                img.dataset.qbInit = 'true';
              }

              if (window.matchMedia(DESKTOP).matches) {
                // DESKTOP → remove data attributes
                img.removeAttribute('data-quick-buy');
                img.removeAttribute('data-quickshop-slim');
                img.removeAttribute('data-variant-id');
              } else {
                // MOBILE → add or update data attributes
                if (img.dataset.qbType === 'quick-buy') {
                  img.setAttribute('data-quickshop-slim', '');
                } else if (img.dataset.qbType === 'quickshop-slim') {
                  img.setAttribute('data-quickshop-slim', '');
                }

                if (img.dataset.qbVariant) {
                  img.setAttribute('data-variant-id', img.dataset.qbVariant);
                }
              }
            });
          }

          // initial run
          toggleQuickBuyOnImages();

          // run on resize with debounce
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(toggleQuickBuyOnImages, 100);
          });

          // run on Shopify dynamic section load
          document.addEventListener('shopify:section:load', toggleQuickBuyOnImages);
        })();
      </script>

      
      <script>
        // Optimize hero slideshow and promo images with mobile-specific optimization - IMMEDIATE for LCP
        (function() {
          function optimizeImages() {
            var isMobile = window.innerWidth <= 768;
            
            // Add fetchpriority to first slideshow image (LCP optimization)
            var firstSlideImage = document.querySelector('.slideshow-slide__image');
            if (firstSlideImage) {
              firstSlideImage.setAttribute('fetchpriority', 'high');
              firstSlideImage.removeAttribute('loading');
              
              // Mobile-specific optimization - EXTREME for 1,144 KiB savings
              if (isMobile && firstSlideImage.classList.contains('slideshow-slide__image--mobile')) {
                var currentSrc = firstSlideImage.getAttribute('src');
                if (currentSrc && (currentSrc.includes('1280x1600') || currentSrc.includes('1280x1599'))) {
                  // Optimize mobile banner: 1280x1600 → 400x500 (EXTREME aggressive for 150 KiB savings)
                  var optimizedSrc = currentSrc.replace(/1280x16\d{2}/g, '400x500');
                  firstSlideImage.setAttribute('src', optimizedSrc);
                  
                  var srcset = firstSlideImage.getAttribute('srcset');
                  if (srcset) {
                    var optimizedSrcset = srcset.replace(/1280x16\d{2}/g, '400x500');
                    firstSlideImage.setAttribute('srcset', optimizedSrcset);
                  }
                }
              }
              
              // Desktop optimization
              if (!isMobile) {
                var currentSrc = firstSlideImage.getAttribute('src');
                if (currentSrc && currentSrc.includes('1920x931')) {
                  var optimizedSrc = currentSrc.replace('1920x931', '1400x680');
                  firstSlideImage.setAttribute('src', optimizedSrc);
                  
                  var srcset = firstSlideImage.getAttribute('srcset');
                  if (srcset) {
                    var optimizedSrcset = srcset.replace(/1920x931/g, '1400x680').replace(/1899x931/g, '1400x680');
                    firstSlideImage.setAttribute('srcset', optimizedSrcset);
                  }
                }
              }
            }
            
            // Optimize all slideshow images
            var allSlideImages = document.querySelectorAll('.slideshow-slide__image');
            allSlideImages.forEach(function(img, index) {
              if (index === 0) return; // Skip first (already optimized)
              
              if (isMobile && img.classList.contains('slideshow-slide__image--mobile')) {
                var src = img.getAttribute('src');
                if (src && (src.includes('1280x1600') || src.includes('1280x1599'))) {
                  img.setAttribute('src', src.replace(/1280x16\d{2}/g, '400x500'));
                }
                
                var srcset = img.getAttribute('srcset');
                if (srcset) {
                  img.setAttribute('srcset', srcset.replace(/1280x16\d{2}/g, '400x500'));
                }
              } else if (!isMobile) {
                var src = img.getAttribute('src');
                if (src && src.includes('1920x931')) {
                  img.setAttribute('src', src.replace('1920x931', '1400x680'));
                }
                
                var srcset = img.getAttribute('srcset');
                if (srcset) {
                  img.setAttribute('srcset', srcset.replace(/1920x931/g, '1400x680').replace(/1899x931/g, '1400x680'));
                }
              }
            });
            
            // Optimize logo for mobile - Match Lighthouse recommendation (displayed 350x86)
            var logoImage = document.querySelector('.site-logo-image');
            if (logoImage && isMobile) {
              var logoSrc = logoImage.getAttribute('src');
              if (logoSrc && (logoSrc.includes('2024x500') || logoSrc.includes('2400x593'))) {
                // Optimize mobile logo: 2024x500 → 350x86 (exact display size for 44.8 KiB savings)
                var optimizedLogoSrc = logoSrc.replace(/2024x500/g, '350x86').replace(/2400x593/g, '350x86').replace(/x200/g, 'x86');
                logoImage.setAttribute('src', optimizedLogoSrc);
                
                var logoSrcset = logoImage.getAttribute('srcset');
                if (logoSrcset) {
                  var optimizedLogoSrcset = logoSrcset.replace(/2024x500/g, '350x86').replace(/2400x593/g, '350x86').replace(/@2x/g, '');
                  logoImage.setAttribute('srcset', optimizedLogoSrcset);
                }
              }
            }
            
            // Optimize promo-mosaic background images with aggressive mobile optimization
            var promoBlocks = document.querySelectorAll('.promo-block[data-rimg-template]');
            promoBlocks.forEach(function(block) {
              var template = block.getAttribute('data-rimg-template');
              var maxSize = block.getAttribute('data-rimg-max');
              
              if (template && maxSize) {
                var dimensions = maxSize.split('x');
                var width = parseInt(dimensions[0]);
                var height = parseInt(dimensions[1]);
                
                // Mobile: reduce to 10% for GIFs (1080x1080 → 108x108) - EXTREME for 1,144 KiB savings
                // Desktop: reduce to 50% for GIFs
                var reductionFactor = isMobile ? 0.10 : 0.5;
                var newWidth = Math.floor(width * reductionFactor);
                var newHeight = Math.floor(height * reductionFactor);
                
                // Get current background image
                var currentBg = window.getComputedStyle(block).backgroundImage;
                if (currentBg && currentBg !== 'none') {
                  // Extract URL and optimize
                  var urlMatch = currentBg.match(/url\(["']?([^"']*)["']?\)/);
                  if (urlMatch && urlMatch[1]) {
                    var url = urlMatch[1];
                    // Replace size parameters
                    var optimizedUrl = url.replace(/(\d+)x(\d+)/, newWidth + 'x' + newHeight);
                    block.style.backgroundImage = 'url(' + optimizedUrl + ')';
                  }
                }
              }
            });
          }
          
          // Run immediately
          optimizeImages();
          
          // Run after DOM is fully loaded
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', optimizeImages);
          }
          
          // Run on dynamic section load (Shopify theme editor)
          document.addEventListener('shopify:section:load', optimizeImages);
          
          // Re-optimize on resize (mobile/desktop switch)
          var resizeTimeout;
          window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(optimizeImages, 200);
          });
        })();
        
        // LAZY LOAD BELOW-FOLD SECTIONS - Load only visible sections
        (function() {
          'use strict';
          var isMobile = window.innerWidth <= 768;
          
          // Only apply aggressive lazy loading on mobile
          if (!isMobile) return;
          
          // Sections to lazy load (below the fold)
          var lazyLoadSelectors = [
            '.promo-mosaic--container',
            '.home-section',
            '.featured-collection',
            '.collection-list',
            '.productgrid--outer'
          ];
          
          // Create Intersection Observer
          var observerOptions = {
            root: null,
            rootMargin: '200px', // Start loading 200px before entering viewport
            threshold: 0.01
          };
          
          var sectionObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                var section = entry.target;
                
                // Load images in this section
                var images = section.querySelectorAll('img[data-src]');
                images.forEach(function(img) {
                  if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                  }
                  if (img.dataset.srcset) {
                    img.srcset = img.dataset.srcset;
                    img.removeAttribute('data-srcset');
                  }
                });
                
                // Load background images
                var bgElements = section.querySelectorAll('[data-bg]');
                bgElements.forEach(function(el) {
                  if (el.dataset.bg) {
                    el.style.backgroundImage = 'url(' + el.dataset.bg + ')';
                    el.removeAttribute('data-bg');
                  }
                });
                
                // Mark section as loaded
                section.classList.add('section-loaded');
                
                // Stop observing this section
                sectionObserver.unobserve(section);
              }
            });
          }, observerOptions);
          
          // Observe all lazy-load sections
          document.addEventListener('DOMContentLoaded', function() {
            lazyLoadSelectors.forEach(function(selector) {
              var sections = document.querySelectorAll(selector);
              sections.forEach(function(section, index) {
                // Skip first section (above the fold)
                if (index === 0 && selector === '.home-section') return;
                
                // Add lazy loading class
                section.classList.add('lazy-section');
                
                // Observe section
                sectionObserver.observe(section);
              });
            });
          });
        })();
        
        // Load Swiper library conditionally
        (function() {
          // Check if we need Swiper (product page or modal)
          const needsSwiper = document.querySelector('#mainSwiper') || document.querySelector('#thumbSwiper');
          
          if (needsSwiper) {
            const script = document.createElement('script');
            script.src = "{{ 'swiper-bundle.min.js' | asset_url }}";
            script.defer = true;
            script.onload = function() {
              if (typeof window.initProductSwiper === 'function') {
                window.initProductSwiper(document);
              }
            };
            document.head.appendChild(script);
          }
        })();

        // Global function to initialize Swipers in a given container
        window.initProductSwiper = function(container = document) {
              if (typeof Swiper === "undefined") return;

              const thumbSwiperEl = container.querySelector('#thumbSwiper');
              const mainSwiperEl = container.querySelector('#mainSwiper');

              if (!thumbSwiperEl || !mainSwiperEl) return;

              // Prevent duplicate initialization
              if (!thumbSwiperEl.swiper && !mainSwiperEl.swiper) {
                const thumbSwiper = new Swiper(thumbSwiperEl, {
                  direction: window.innerWidth > 768 ? 'vertical' : 'horizontal',
                  slidesPerView: 'auto',
                  spaceBetween: 10,
                  watchSlidesProgress: true,
                  watchSlidesVisibility: true,
                });

                const mainSwiper = new Swiper(mainSwiperEl, {
                  spaceBetween: 10,
                  navigation: {
                    nextEl: container.querySelector('.swiper-button-next'),
                    prevEl: container.querySelector('.swiper-button-prev')
                  },
                  thumbs: {
                    swiper: thumbSwiper
                  }
                });

                // Responsive direction on resize
                window.addEventListener('resize', () => {
                  const newDirection = window.innerWidth > 768 ? 'vertical' : 'horizontal';
                  if (thumbSwiper.params.direction !== newDirection) {
                    thumbSwiper.changeDirection(newDirection);
                  }
                });
              } else {
                // Already initialized, just update
                thumbSwiperEl.swiper.update();
                mainSwiperEl.swiper.update();
              }
            };

            // === Initialize on product page immediately ===
            document.addEventListener('DOMContentLoaded', () => {
              window.initProductSwiper(document);
            });

            // === MutationObserver for QuickView content injection ===
            const observer = new MutationObserver((mutationsList) => {
              for (const mutation of mutationsList) {
                mutation.addedNodes.forEach(node => {
                  if (node.nodeType === 1) { // Element node
                    // Check if modal-inner or product slider is added
                    const modalInner = node.matches('.modal-inner') ? node : node.querySelector('.modal-inner');
                    if (modalInner) {
                      window.initProductSwiper(modalInner);
                    }

                    // Optional: also handle dynamically injected sliders outside modal
                    const sliderContainer = node.querySelector('#mainSwiper');
                    if (sliderContainer) {
                      window.initProductSwiper(node);
                    }
                  }
                });
              }
            });

            // Observe the body for added nodes (lightweight)
            observer.observe(document.body, { childList: true, subtree: true });

      </script>

    
    {% comment %} Aggressive third-party script deferral for performance {% endcomment %}
    <script>
      // Defer ALL non-critical scripts until page is fully interactive
      (function() {
        var loaded = false;
        var scriptsDeferred = false;
        
        function deferHeavyScripts() {
          if (scriptsDeferred) return;
          scriptsDeferred = true;
          
          // EXTREME mobile delays to drastically reduce Script Evaluation
          var isMobile = window.innerWidth <= 768;
          var wpmDelay = isMobile ? 15000 : 5000;
          var analyticsDelay = isMobile ? 12000 : 4000;
          
          // Defer WPM tracking (703ms execution time)
          var wpmScripts = document.querySelectorAll('script[src*="/wpm/"]');
          wpmScripts.forEach(function(script) {
            if (!script.hasAttribute('data-deferred')) {
              var newScript = document.createElement('script');
              newScript.src = script.src;
              newScript.async = true;
              newScript.setAttribute('data-deferred', 'true');
              script.parentNode.removeChild(script);
              setTimeout(function() {
                document.body.appendChild(newScript);
              }, wpmDelay);
            }
          });
          
          // Defer Plerdy (289ms), Clarity (152ms), Autoketing (153ms), Personalizer (180ms), Shopify preview bar, superlemon
          var analyticsScripts = document.querySelectorAll('script[src*="plerdy"], script[src*="clarity"], script[src*="autoketing"], script[src*="crazyegg"], script[src*="hextom"], script[src*="smile.io"], script[src*="personalizer"], script[src*="preview-bar"], script[src*="superlemon"]');
          analyticsScripts.forEach(function(script) {
            if (!script.hasAttribute('data-deferred')) {
              script.setAttribute('data-deferred', 'true');
              var src = script.src;
              script.parentNode.removeChild(script);
              
              setTimeout(function() {
                var newScript = document.createElement('script');
                newScript.src = src;
                newScript.async = true;
                document.body.appendChild(newScript);
              }, analyticsDelay);
            }
          });
        }
        
        function loadDeferredScripts() {
          if (loaded) return;
          loaded = true;
          
          // Load Limespot - moved outside script tag
        }
        
        // Defer heavy scripts immediately
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', deferHeavyScripts);
        } else {
          deferHeavyScripts();
        }
        
        // Load lighter scripts after user interaction or 2 seconds
        var events = ['mousemove', 'scroll', 'touchstart', 'keydown'];
        var loadOnce = function() {
          loadDeferredScripts();
          events.forEach(function(e) {
            window.removeEventListener(e, loadOnce);
          });
        };
        
        events.forEach(function(e) {
          window.addEventListener(e, loadOnce, { passive: true, once: true });
        });
        
        // Fallback: load after 2 seconds
        setTimeout(loadDeferredScripts, 2000);
      })();
    </script>
    
    {% comment %} Optimize empire.js execution {% endcomment %}
    <script>
      // Split empire.js execution into chunks to reduce blocking
      (function() {
        // Mark body as loaded after critical scripts
        window.addEventListener('load', function() {
          document.body.classList.add('loaded');
        });
        
        if (typeof window.requestIdleCallback !== 'undefined') {
          // Use idle callbacks for non-critical empire.js features
          window.requestIdleCallback(function() {
            // Non-critical features can initialize here
            if (window.theme && window.theme.initNonCritical) {
              window.theme.initNonCritical();
            }
          }, { timeout: 2000 });
        }
        
        // Optimize long tasks by breaking them up
        if ('scheduler' in window && 'yield' in window.scheduler) {
          // Use modern scheduler API if available
          window.optimizeTask = async function(callback) {
            await scheduler.yield();
            callback();
          };
        } else {
          // Fallback to setTimeout
          window.optimizeTask = function(callback) {
            setTimeout(callback, 0);
          };
        }
      })();
    </script>
    
    {% comment %} Reduce JavaScript execution time with performance hints {% endcomment %}
    <script>
      // Performance optimization: reduce forced synchronous layouts
      (function() {
        var rafScheduled = false;
        var mutations = [];
        
        // Batch DOM reads and writes
        window.batchDOMUpdate = function(readFn, writeFn) {
          if (readFn) {
            var result = readFn();
          }
          
          if (writeFn) {
            if (!rafScheduled) {
              rafScheduled = true;
              requestAnimationFrame(function() {
                writeFn(result);
                rafScheduled = false;
              });
            }
          }
        };
        
        // Debounce expensive operations
        window.debounce = function(func, wait) {
          var timeout;
          return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
              func.apply(context, args);
            }, wait);
          };
        };
        
        // Throttle for scroll/resize events
        window.throttle = function(func, limit) {
          var inThrottle;
          return function() {
            var args = arguments;
            var context = this;
            if (!inThrottle) {
              func.apply(context, args);
              inThrottle = true;
              setTimeout(function() { inThrottle = false; }, limit);
            }
          };
        };
        
        // Break up long tasks
        window.yieldToMain = function() {
          return new Promise(function(resolve) {
            setTimeout(resolve, 0);
          });
        };
        
        // Passive event listeners by default
        var originalAddEventListener = EventTarget.prototype.addEventListener;
        EventTarget.prototype.addEventListener = function(type, listener, options) {
          var passiveEvents = ['scroll', 'wheel', 'touchstart', 'touchmove', 'touchend', 'touchcancel'];
          if (passiveEvents.indexOf(type) !== -1 && typeof options !== 'object') {
            options = { passive: true };
          }
          return originalAddEventListener.call(this, type, listener, options);
        };
      })();
    </script>
    
    {% comment %} Minimize main thread work {% endcomment %}
    <script>
      // Reduce JavaScript execution by optimizing event handlers
      (function() {
        // Intercept and optimize jQuery if loaded
        var jQueryOptimized = false;
        
        function optimizeJQuery() {
          if (jQueryOptimized || typeof jQuery === 'undefined') return;
          jQueryOptimized = true;
          
          // Cache jQuery selectors
          var selectorCache = {};
          var originalFind = jQuery.fn.find;
          jQuery.fn.find = function(selector) {
            if (typeof selector === 'string') {
              var cacheKey = this.selector + ' ' + selector;
              if (!selectorCache[cacheKey]) {
                selectorCache[cacheKey] = originalFind.call(this, selector);
              }
              return selectorCache[cacheKey];
            }
            return originalFind.call(this, selector);
          };
          
          // Optimize jQuery animations to use CSS when possible
          var originalAnimate = jQuery.fn.animate;
          jQuery.fn.animate = function(properties, duration, easing, complete) {
            // For simple transforms, use CSS transitions
            var canUseCSS = true;
            for (var prop in properties) {
              if (!['opacity', 'left', 'top', 'right', 'bottom'].includes(prop)) {
                canUseCSS = false;
                break;
              }
            }
            
            if (canUseCSS && duration < 1000) {
              this.css('transition', 'all ' + (duration || 400) + 'ms ease');
              this.css(properties);
              if (complete) {
                setTimeout(complete.bind(this[0]), duration || 400);
              }
              return this;
            }
            
            return originalAnimate.call(this, properties, duration, easing, complete);
          };
        }
        
        // Try to optimize after jQuery loads
        setTimeout(optimizeJQuery, 1000);
        
        // Reduce reflows by batching style changes
        var styleQueue = [];
        var styleFlushScheduled = false;
        
        window.queueStyleChange = function(element, styles) {
          styleQueue.push({ element: element, styles: styles });
          
          if (!styleFlushScheduled) {
            styleFlushScheduled = true;
            requestAnimationFrame(function() {
              styleQueue.forEach(function(item) {
                Object.keys(item.styles).forEach(function(key) {
                  item.element.style[key] = item.styles[key];
                });
              });
              styleQueue = [];
              styleFlushScheduled = false;
            });
          }
        };
        
        // Reduce garbage collection by reusing objects
        var objectPool = [];
        window.getPooledObject = function() {
          return objectPool.pop() || {};
        };
        
        window.releasePooledObject = function(obj) {
          for (var key in obj) {
            delete obj[key];
          }
          if (objectPool.length < 50) {
            objectPool.push(obj);
          }
        };
        
        // Optimize event delegation
        var delegatedEvents = {};
        window.optimizedDelegate = function(selector, event, handler) {
          var key = event + ':' + selector;
          if (!delegatedEvents[key]) {
            delegatedEvents[key] = [];
            document.addEventListener(event, function(e) {
              var target = e.target.closest(selector);
              if (target) {
                delegatedEvents[key].forEach(function(h) {
                  h.call(target, e);
                });
              }
            }, { passive: true });
          }
          delegatedEvents[key].push(handler);
        };
      })();
    </script>
    
    {% comment %} Reduce Script Evaluation with code splitting {% endcomment %}
    <script>
      // Split heavy operations into chunks
      (function() {
        // Chunk processor for heavy operations
        window.processInChunks = function(items, processor, callback) {
          var index = 0;
          var chunkSize = 10;
          
          function processChunk() {
            var end = Math.min(index + chunkSize, items.length);
            
            for (var i = index; i < end; i++) {
              processor(items[i], i);
            }
            
            index = end;
            
            if (index < items.length) {
              setTimeout(processChunk, 0);
            } else if (callback) {
              callback();
            }
          }
          
          processChunk();
        };
        
        // Lazy initialize features
        var initializedFeatures = {};
        window.lazyInit = function(featureName, initFunction) {
          if (initializedFeatures[featureName]) return;
          initializedFeatures[featureName] = true;
          
          if ('requestIdleCallback' in window) {
            requestIdleCallback(initFunction, { timeout: 2000 });
          } else {
            setTimeout(initFunction, 100);
          }
        };
      })();
    </script>
  </body>  
</html>